<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¦æ´¾æ™ºèƒ½èŠå¤©å®¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>å¸¦æ´¾æ™ºèƒ½èŠå¤©å®¤</h2>
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œ{{ nickname }}</span>
                <button id="logout-btn">é€€å‡º</button>
            </div>
        </div>
        
        <div class="chat-main">
            <div class="users-sidebar">
                <div class="sidebar-header">
                    <h3>åœ¨çº¿ç”¨æˆ·</h3>
                </div>
                <div class="users-list" id="users-list">
                    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <p>æ¬¢è¿æ¥åˆ°å¸¦æ´¾æ™ºèƒ½èŠå¤©å®¤ï¼</p>
                    <p>æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
                    <ul>
                        <li>@å¥¶å°èƒ– [æ¶ˆæ¯] - ä¸AIåŠ©æ‰‹å¯¹è¯</li>
                        <li>@ç”µå½± [URL] - åˆ†äº«ç”µå½±é“¾æ¥</li>
                        <li>@ç”¨æˆ·å - @å…¶ä»–ç”¨æˆ·</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="chat-footer">
            <div class="emoji-picker" id="emoji-picker">
                <button id="emoji-btn">ğŸ˜Š</button>
                <div class="emoji-panel">
                    <!-- emojiåˆ†ç±»æ ‡ç­¾ -->
                    <div class="emoji-tabs">
                        <button class="emoji-tab active" data-category="face">ğŸ˜€</button>
                        <button class="emoji-tab" data-category="hand">ğŸ‘</button>
                        <button class="emoji-tab" data-category="heart">â¤ï¸</button>
                        <button class="emoji-tab" data-category="animal">ğŸ¶</button>
                        <button class="emoji-tab" data-category="food">ğŸ”</button>
                        <button class="emoji-tab" data-category="activity">âš½</button>
                        <button class="emoji-tab" data-category="travel">ğŸš—</button>
                        <button class="emoji-tab" data-category="object">ğŸ“±</button>
                        <button class="emoji-tab" data-category="symbol">â­</button>
                        <button class="emoji-tab" data-category="flag">ğŸš©</button>
                    </div>
                    
                    <!-- emojiå†…å®¹åŒºåŸŸ -->
                    <div class="emoji-content">
                        <!-- é¢éƒ¨è¡¨æƒ… -->
                        <div class="emoji-list" data-category="face">
                            ğŸ˜€ ğŸ˜ƒ ğŸ˜„ ğŸ˜ ğŸ˜† ğŸ˜… ğŸ˜‚ ğŸ¤£ ğŸ˜Š ğŸ˜‡ ğŸ™‚ ğŸ™ƒ ğŸ˜‰ ğŸ˜Œ ğŸ˜ ğŸ¥° ğŸ˜˜ ğŸ˜— ğŸ˜™ ğŸ˜š ğŸ˜‹ ğŸ˜› ğŸ˜ ğŸ˜œ ğŸ¤ª ğŸ¤¨ ğŸ§ ğŸ¤“ ğŸ˜ ğŸ¤© ğŸ¥³ ğŸ˜ ğŸ˜’ ğŸ˜ ğŸ˜” ğŸ˜Ÿ ğŸ˜• ğŸ™ â˜¹ï¸ ğŸ˜£ ğŸ˜– ğŸ˜« ğŸ˜© ğŸ¥º ğŸ˜¢ ğŸ˜­ ğŸ˜¤ ğŸ˜  ğŸ˜¡ ğŸ¤¬ ğŸ¤¯ ğŸ˜³ ğŸ¥µ ğŸ¥¶ ğŸ˜± ğŸ˜¨ ğŸ˜° ğŸ˜¥ ğŸ˜“ ğŸ¤— ğŸ¤” ğŸ¤­ ğŸ¤« ğŸ¤¥ ğŸ˜¶ ğŸ˜ ğŸ˜‘ ğŸ˜¬ ğŸ™„ ğŸ˜¯ ğŸ˜¦ ğŸ˜§ ğŸ˜® ğŸ˜² ğŸ¥± ğŸ˜´ ğŸ¤¤ ğŸ˜ª ğŸ˜µ ğŸ¤ ğŸ¥´ ğŸ¤¢ ğŸ¤® ğŸ¤§ ğŸ˜· ğŸ¤’ ğŸ¤• ğŸ¤‘ ğŸ¤  ğŸ˜ˆ ğŸ‘¿ ğŸ‘¹ ğŸ‘º ğŸ¤¡ ğŸ’© ğŸ‘» ğŸ’€ â˜ ï¸ ğŸ‘½ ğŸ‘¾ ğŸ¤– ğŸƒ ğŸ˜º ğŸ˜¸ ğŸ˜¹ ğŸ˜» ğŸ˜¼ ğŸ˜½ ğŸ™€ ğŸ˜¿ ğŸ˜¾
                        </div>
                        
                        <!-- æ‰‹åŠ¿ -->
                        <div class="emoji-list" data-category="hand" style="display:none;">
                            ğŸ‘‹ ğŸ¤š ğŸ– âœ‹ ğŸ–– ğŸ‘Œ ğŸ¤ âœŒï¸ ğŸ¤ ğŸ¤Ÿ ğŸ¤˜ ğŸ¤™ ğŸ‘ˆ ğŸ‘‰ ğŸ‘† ğŸ‘‡ â˜ï¸ ğŸ‘ ğŸ‘ âœŠ ğŸ‘Š ğŸ¤› ğŸ¤œ ğŸ‘ ğŸ™Œ ğŸ‘ ğŸ¤² ğŸ¤ ğŸ™ âœï¸ ğŸ’ª ğŸ¦¾ ğŸ¦µ ğŸ¦¶ ğŸ‘£ ğŸ‘‚ ğŸ¦» ğŸ§  ğŸ¦· ğŸ¦´ ğŸ‘€ ğŸ‘ï¸ ğŸ‘… ğŸ‘„ ğŸ’‹ ğŸ©¸
                        </div>
                        
                        <!-- å¿ƒå½¢ -->
                        <div class="emoji-list" data-category="heart" style="display:none;">
                            â¤ï¸ ğŸ§¡ ğŸ’› ğŸ’š ğŸ’™ ğŸ’œ ğŸ–¤ ğŸ¤ ğŸ¤ ğŸ’” â£ï¸ ğŸ’– ğŸ’— ğŸ’“ ğŸ’ ğŸ’˜ ğŸ’ ğŸ’Ÿ ğŸ’• ğŸ¥° ğŸ˜ ğŸ˜˜ ğŸ˜»
                        </div>
                        
                        <!-- åŠ¨ç‰© -->
                        <div class="emoji-list" data-category="animal" style="display:none;">
                            ğŸ¶ ğŸ± ğŸ­ ğŸ¹ ğŸ° ğŸ¦Š ğŸ» ğŸ¼ ğŸ¨ ğŸ¯ ğŸ¦ ğŸ® ğŸ· ğŸ½ ğŸ¸¸ ğŸ¸ ğŸµ ğŸ™ˆ ğŸ™‰ ğŸ™Š ğŸ” ğŸ§ ğŸ¦ ğŸ¤ ğŸ£ ğŸ¥ ğŸ¦† ğŸ¦… ğŸ¦‰ ğŸ¦‡ ğŸº ğŸ— ğŸ´ ğŸ¦„ ğŸ ğŸ› ğŸ¦‹ ğŸŒ ğŸ ğŸœ ğŸ¦— ğŸ•·ï¸ ğŸ•¸ï¸ ğŸ¦‚ ğŸ¢ ğŸ ğŸ¦ ğŸ¦– ğŸ¦• ğŸ™ ğŸš ğŸ  ğŸŸ ğŸ¡ ğŸ¬ ğŸ³ ğŸ‹ ğŸ¦ˆ ğŸŠ ğŸ… ğŸ† ğŸ¦“ ğŸ¦ ğŸ¦§ ğŸ˜ ğŸ¦› ğŸ¦ ğŸª ğŸ« ğŸ¦’ ğŸ¦˜ ğŸ¦ ğŸ¦¡ ğŸ€ ğŸ ğŸ­ ğŸ¹ ğŸ° ğŸ‡ ğŸ¿ï¸ ğŸ¦¨ ğŸ¦¡ ğŸ¦¦ ğŸ¦¥ ğŸ¦” ğŸ‰ ğŸ² ğŸ¦‘ ğŸ¦ ğŸ¦ ğŸ¦€ ğŸ¡ ğŸ  ğŸŸ ğŸ¬ ğŸ³ ğŸ‹
                        </div>
                        
                        <!-- é£Ÿç‰© -->
                        <div class="emoji-list" data-category="food" style="display:none;">
                            ğŸ ğŸ ğŸ ğŸŠ ğŸ‹ ğŸŒ ğŸ‰ ğŸ‡ ğŸ“ ğŸˆ ğŸ’ ğŸ‘ ğŸ¥­ ğŸ ğŸ¥¥ ğŸ¥ ğŸ… ğŸ† ğŸ¥‘ ğŸ¥¦ ğŸ¥¬ ğŸ¥’ ğŸŒ¶ï¸ ğŸŒ½ ğŸ¥• ğŸ§„ ğŸ§… ğŸ¥” ğŸ  ğŸ¥ ğŸ¥– ğŸ§€ ğŸ¥š ğŸ³ ğŸ§ˆ ğŸ” ğŸ“ ğŸ— ğŸ– ğŸ¥© ğŸ¥“ ğŸ ğŸ¥ ğŸ¥– ğŸ¥¨ ğŸ§€ ğŸ§ ğŸ° ğŸ‚ ğŸ® ğŸ­ ğŸ¬ ğŸ« ğŸ¿ ğŸ¥œ ğŸŒ° ğŸ¯ ğŸ¥› ğŸ¼ ğŸµ â˜• ğŸ¶ ğŸº ğŸ» ğŸ¥‚ ğŸ· ğŸ¥ƒ ğŸ¸ ğŸ¹ ğŸ§ƒ ğŸ§‰ ğŸ¥¤ ğŸ¥¢ ğŸ½ï¸ ğŸ´ ğŸ¥„ ğŸ¾
                        </div>
                        
                        <!-- æ´»åŠ¨ -->
                        <div class="emoji-list" data-category="activity" style="display:none;">
                            âš½ ğŸ¾ ğŸ€ ğŸ ğŸˆ âš¾ ğŸ¥ ğŸ ğŸ‰ ğŸ¥ ğŸ± ğŸª€ ğŸ“ ğŸ¸ ğŸ’ ğŸ‘ ğŸªƒ ğŸ£ ğŸ¤¿ ğŸ›¹ ğŸ›· ğŸ¥Œ ğŸ¿ â›¸ï¸ ğŸª‚ ğŸ‹ï¸ ğŸ¤¼ ğŸ¤¸ ğŸ¤º ğŸ¤¾ ğŸŒï¸ ğŸ‡ ğŸ§˜ ğŸ¤½ ğŸ¤¾ ğŸŒï¸ ğŸ„ ğŸ¤½ ğŸ¤¾ ğŸŠ ğŸ¤¿ ğŸ§—
                        </div>
                        
                        <!-- æ—…è¡Œ -->
                        <div class="emoji-list" data-category="travel" style="display:none;">
                            ğŸš— ğŸš• ğŸš™ ğŸšŒ ğŸš ğŸï¸ ğŸš“ ğŸš‘ ğŸš’ ğŸš ğŸšš ğŸš› ğŸšœ ğŸ¦½ ğŸ¦¼ ğŸ›´ ğŸš² ğŸ›µ ğŸï¸ ğŸ›º ğŸš” ğŸš ğŸš˜ ğŸš– ğŸš¨ ğŸš¨ ğŸš’ ğŸš‘ ğŸš“ ğŸšš ğŸš› ğŸšœ ğŸš€ ğŸ›¸ ğŸ›°ï¸ ğŸ›« ğŸ›¬ âœˆï¸ ğŸ›©ï¸ ğŸ›°ï¸ ğŸš ğŸ›¸ ğŸ›³ï¸ â›µ ğŸš¤ ğŸ›¥ï¸ âš“ ğŸš¢ âš“ ğŸ›¶ ğŸš£ ğŸš£â€â™‚ï¸ ğŸš£â€â™€ï¸ ğŸ›³ï¸ â›µ ğŸš¤
                        </div>
                        
                        <!-- ç‰©ä½“ -->
                        <div class="emoji-list" data-category="object" style="display:none;">
                            ğŸ“± ğŸ“² ğŸ’» ğŸ–¥ï¸ ğŸ–¨ï¸ ğŸ“  ğŸ“ ğŸ“Ÿ ğŸ“  ğŸ”‹ ğŸ”Œ ğŸ’¡ ğŸ”¦ ğŸš¨ ğŸš¦ ğŸš¥ âš ï¸ ğŸ“¢ ğŸ“£ ğŸ“¯ ğŸ”” ğŸ”• â° â±ï¸ â²ï¸ ğŸ•°ï¸ â³ âŒ› ğŸ“… ğŸ“† ğŸ“‡ ğŸ“ˆ ğŸ“‰ ğŸ“Š ğŸ“‹ ğŸ“ ğŸ“œ ğŸ“ƒ ğŸ“„ ğŸ“° ğŸ—ï¸ ğŸ“š ğŸ“– ğŸ“• ğŸ“— ğŸ“˜ ğŸ“™ ğŸ“” ğŸ“’ ğŸ““ ğŸ“™ ğŸ“— ğŸ“˜ ğŸ“• ğŸ“– ğŸ“š ğŸ“š ğŸ“” ğŸ“’ ğŸ““
                        </div>
                        
                        <!-- ç¬¦å· -->
                        <div class="emoji-list" data-category="symbol" style="display:none;">
                            â­ ğŸŒŸ ğŸ’« âœ¨ âš¡ â˜„ï¸ ğŸ’¥ ğŸ”¥ ğŸ’§ ğŸŒŠ ğŸŒˆ ğŸŒªï¸ ğŸŒ«ï¸ ğŸŒ¨ï¸ ğŸŒ§ï¸ ğŸŒ¦ï¸ ğŸŒ¤ï¸ â˜€ï¸ ğŸŒ™ ğŸŒš ğŸŒ› ğŸŒœ â›… â˜ï¸ ğŸŒ«ï¸ ğŸŒ¬ï¸ ğŸ’¨ ğŸŒ©ï¸ âš¡ ğŸŒ‹ ğŸŒ ğŸŒ ğŸŒ ğŸŒ ğŸ—ºï¸ ğŸ—¾ ğŸ—¿ ğŸ”ï¸ â›°ï¸ ğŸŒ‹ ğŸŒ„ ğŸŒ… ğŸŒ† ğŸŒ‡ ğŸŒ‰ ğŸŒ ğŸ™ï¸ ğŸ˜ï¸ ğŸšï¸ ğŸ—ï¸ ğŸ­ ğŸ¢ ğŸ¬ ğŸ£ ğŸ¤ ğŸ¥ ğŸ¦ ğŸ¨ ğŸª ğŸ« ğŸ¬ ğŸ£ ğŸ¤ ğŸ¥ ğŸ¦ ğŸ¨ ğŸª ğŸ« ğŸ© ğŸª ğŸ«
                        </div>
                        
                        <!-- æ——å¸œ -->
                        <div class="emoji-list" data-category="flag" style="display:none;">
                            ğŸš© ğŸ‡¨ğŸ‡³ ğŸ‡ºğŸ‡¸ ğŸ‡¬ğŸ‡§ ğŸ‡«ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡¯ğŸ‡µ ğŸ‡°ğŸ‡· ğŸ‡®ğŸ‡¹ ğŸ‡ªğŸ‡¸ ğŸ‡·ğŸ‡º ğŸ‡¨ğŸ‡¦ ğŸ‡¦ğŸ‡º ğŸ‡®ğŸ‡³ ğŸ‡§ğŸ‡· ğŸ‡²ğŸ‡½ ğŸ‡¨ğŸ‡± ğŸ‡¨ğŸ‡´ ğŸ‡µğŸ‡ª ğŸ‡¨ğŸ‡º ğŸ‡­ğŸ‡° ğŸ‡²ğŸ‡´ ğŸ‡¹ğŸ‡¼
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-group">
                <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæ”¯æŒ@å‘½ä»¤å’Œemojiè¡¨æƒ…ï¼‰" rows="1"></textarea>
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        $(document).ready(function() {
            const nickname = '{{ nickname }}';
            let socket = null;
            
            // è¿æ¥WebSocket
            function connectSocket() {
                // è·å–å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœº
                const protocol = window.location.protocol;
                const host = window.location.host;
                const socketUrl = `${protocol}//${host}`;
                
                socket = io(socketUrl);
                
                // è¿æ¥æˆåŠŸ
                socket.on('connect', function() {
                    console.log('WebSocket connected');
                    // åŠ å…¥èŠå¤©å®¤
                    socket.emit('join', { nickname: nickname });
                });
                
                // åŠ å…¥æˆåŠŸ
                socket.on('join_success', function(data) {
                    updateUsersList(data.users);
                    appendMessage('ç³»ç»Ÿ', data.message, 'system');
                });
                
                // ç”¨æˆ·åŠ å…¥
                socket.on('user_joined', function(data) {
                    updateUsersList(data.users);
                    appendMessage('ç³»ç»Ÿ', `${data.nickname} åŠ å…¥äº†èŠå¤©å®¤`, 'system');
                });
                
                // ç”¨æˆ·ç¦»å¼€
                socket.on('user_left', function(data) {
                    updateUsersList(data.users);
                    appendMessage('ç³»ç»Ÿ', `${data.nickname} ç¦»å¼€äº†èŠå¤©å®¤`, 'system');
                });
                
                // æ¥æ”¶æ¶ˆæ¯
                socket.on('receive_message', function(data) {
                    appendMessage(data.nickname, data.message, data.type);
                });
                
                // æ–­å¼€è¿æ¥
                socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                    appendMessage('ç³»ç»Ÿ', 'è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'system');
                });
            }
            
            // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            function updateUsersList(users) {
                const usersList = $('#users-list');
                usersList.empty();
                users.forEach(user => {
                    const isCurrentUser = user === nickname;
                    usersList.append(`
                        <div class="user-item ${isCurrentUser ? 'current-user' : ''}">
                            <span class="user-status"></span>
                            <span class="user-name">${user}${isCurrentUser ? ' (æˆ‘)' : ''}</span>
                        </div>
                    `);
                });
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            function appendMessage(sender, message, type) {
                const messagesDiv = $('#chat-messages');
                let messageClass = 'message';
                
                if (type === 'system') {
                    messageClass = 'message system-message';
                } else if (type === 'ai_response') {
                    messageClass = 'message ai-message';
                } else if (type === 'movie_link') {
                    messageClass = 'message movie-message';
                } else if (type === 'mention') {
                    messageClass = 'message mention-message';
                } else if (sender === nickname) {
                    messageClass = 'message my-message';
                }
                
                messagesDiv.append(`
                    <div class="${messageClass}">
                        ${type !== 'system' ? `<div class="message-header">${sender}</div>` : ''}
                        <div class="message-content"></div>
                    </div>
                `);
                
                // ä½¿ç”¨html()æ–¹æ³•ä»¥æ”¯æŒiframeç­‰HTMLå†…å®¹
                const lastMessage = messagesDiv.children().last().find('.message-content');
                lastMessage.html(message);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                messagesDiv.scrollTop(messagesDiv.prop('scrollHeight'));
            }
            
            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const messageInput = $('#message-input');
                const message = messageInput.val().trim();
                
                if (message && socket) {
                    socket.emit('send_message', { nickname: nickname, message: message });
                    messageInput.val('');
                }
            }
            
            // é€€å‡ºèŠå¤©å®¤
            function logout() {
                if (socket) {
                    socket.emit('leave', { nickname: nickname });
                    socket.disconnect();
                }
                window.location.href = '/';
            }
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†emojiç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿åŠ¨æ€åˆ›å»ºçš„emojiä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
            $('.emoji-content').on('click', '.emoji-list span', function(e) {
                e.stopPropagation(); // é˜²æ­¢å…³é—­emojié¢æ¿
                
                const emoji = $(this).text();
                const messageInput = $('#message-input');
                
                // è·å–å½“å‰å…‰æ ‡ä½ç½®
                const start = messageInput.prop('selectionStart');
                const end = messageInput.prop('selectionEnd');
                const text = messageInput.val();
                
                // åœ¨å…‰æ ‡ä½ç½®æ’å…¥emoji
                messageInput.val(text.substring(0, start) + emoji + text.substring(end));
                
                // é‡æ–°èšç„¦å¹¶è®¾ç½®å…‰æ ‡ä½ç½®
                messageInput.focus();
                const newCursorPos = start + emoji.length;
                messageInput.prop('selectionStart', newCursorPos);
                messageInput.prop('selectionEnd', newCursorPos);
                
                // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                adjustTextareaHeight();
            });
            
            // åˆå§‹åŒ–emojiåˆ—è¡¨å‡½æ•°
            function initEmojiPanels() {
                $('.emoji-list').each(function() {
                    const emojiList = $(this);
                    const emojis = emojiList.text().trim().split(' ');
                    emojiList.empty();
                    emojis.forEach(emoji => {
                        emojiList.append(`<span>${emoji}</span>`);
                    });
                });
            }
            
            // åˆå§‹åŒ–emojiåˆ—è¡¨
            initEmojiPanels();
            
            // åˆ‡æ¢emojié€‰æ‹©å™¨æ˜¾ç¤º
            $('#emoji-btn').on('click', function(e) {
                e.stopPropagation();
                $('.emoji-panel').toggle();
            });
            
            // emojiåˆ†ç±»åˆ‡æ¢
            $('.emoji-tab').on('click', function() {
                const category = $(this).data('category');
                
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                $('.emoji-tab').removeClass('active');
                $(this).addClass('active');
                
                // åˆ‡æ¢emojiåˆ—è¡¨æ˜¾ç¤º
                $('.emoji-list').hide();
                $(`.emoji-list[data-category="${category}"]`).show();
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­emojié€‰æ‹©å™¨
            $(document).on('click', function(event) {
                if (!$(event.target).closest('#emoji-picker').length) {
                    $('.emoji-panel').hide();
                }
            });
            
            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#send-btn').on('click', sendMessage);
            
            // å›è½¦å‘é€æ¶ˆæ¯ï¼ˆCtrl+Enteræ¢è¡Œï¼‰
            $('#message-input').on('keydown', function(e) {
                if (e.which === 13 && !e.ctrlKey && !e.shiftKey) {  // Enteré”®
                    e.preventDefault();
                    sendMessage();
                } else if (e.which === 13 && (e.ctrlKey || e.shiftKey)) {
                    // Ctrl+Enteræˆ–Shift+Enteræ¢è¡Œï¼Œè®©æµè§ˆå™¨é»˜è®¤å¤„ç†
                    setTimeout(adjustTextareaHeight, 0);
                }
            });
            
            // è¾“å…¥æ—¶è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
            $('#message-input').on('input', adjustTextareaHeight);
            
            // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦å‡½æ•°
            function adjustTextareaHeight() {
                const textarea = $('#message-input');
                textarea.css('height', 'auto');
                const scrollHeight = textarea.prop('scrollHeight');
                // é™åˆ¶æœ€å¤§é«˜åº¦
                const maxHeight = 120;
                textarea.css('height', Math.min(scrollHeight, maxHeight) + 'px');
            }
            
            // é€€å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#logout-btn').on('click', logout);
            
            // é¡µé¢å…³é—­å‰æ–­å¼€è¿æ¥
            window.addEventListener('beforeunload', function() {
                if (socket) {
                    socket.emit('leave', { nickname: nickname });
                    socket.disconnect();
                }
            });
            
            // åˆå§‹åŒ–è¿æ¥
            connectSocket();
        });
    </script>
</body>
</html>